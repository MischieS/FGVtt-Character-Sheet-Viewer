<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fantasy Grounds Character Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>.abilities-tab {
  padding-bottom: 6px;
}

.abilities-stack {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.ability-panel {
  padding: 0;
}

.ability-header {
  display: grid;
  grid-template-columns: 1fr 150px;
  padding: 6px 10px;
  border-bottom: 1px solid #b9a88f;
  font-size: 11px;
  letter-spacing: 0.18em;
  color: var(--fg-text-muted);
}

.abilities-heading {
  text-transform: uppercase;
}

.skills-heading,
.abilities-heading,
.inventory-heading,
.powers-heading {
  text-transform: uppercase;
}

.hp-field-hd {
  width: 90px;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.table th,
.table td {
  padding: 4px 6px;
  border-bottom: 1px solid #c3b39a;
  vertical-align: middle;
  text-align: center;
}

.table td:first-child,
.table th:first-child {
  text-align: left;
}


.skills-col-name,
.abilities-col-name,
.inventory-col-name,
.powers-col-name {
  padding-left: 4px;
  text-align: left;
  justify-self: start;
}

.powers-header span:not(.powers-col-name) {
  text-align: center;
  justify-self: center;
}

.ability-panel .ability-list {
  list-style: none;
  margin: 0;
  padding: 0;
}

.ability-row {
  display: grid;
  grid-template-columns: 1fr 150px;
  align-items: start;
  justify-items: center;
  padding: 6px 10px;
  gap: 8px;
  border-bottom: 1px solid rgba(0,0,0,0.08);
  cursor: pointer;
}

.ability-row:nth-child(odd) {
  background: rgba(0,0,0,0.03);
}

.ability-row:hover {
  background: rgba(0,0,0,0.07);
}

.ability-name {
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  text-align: left;
  justify-self: stretch;
}

.ability-note {
  font-size: 12px;
  color: var(--fg-text-muted);
  text-align: left;
  justify-self: start;
}

.ability-row-static {
  cursor: default;
}

.ability-detail {
  grid-column: 1 / -1;
  margin-top: 4px;
  padding: 6px 8px;
  background: #f3ead8;
  border-radius: 4px;
  font-size: 12px;
  color: var(--fg-text-main);
  display: none;
  align-items: center;
  justify-content: flex-start;
  text-align: left;
}

.ability-row.expanded .ability-detail {
  display: flex;
}

.ability-row.expanded .ability-panel {
  --fg-border-dark: #5b4a3a;
  --fg-border-light: #c4b499;
  --fg-accent: #8a6b45;
  --fg-text-main: #3b2c1f;
  --fg-text-muted: #7a6b58;
  --fg-panel-header-bg: #d0c2ab;
}

* {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
  min-height: 100%;
  font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: radial-gradient(circle at top, #65523c 0, #403126 40%, #261b14 100%);
}

body {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  color: var(--fg-text-main);
}

.app-root {
  width: 100%;
  max-width: 960px;
  min-height: 90vh;
  background: linear-gradient(#f1e6d5, #e1d3bf);
  border-radius: 8px;
  border: 3px solid #2b2219;
  box-shadow: 0 14px 35px rgba(0,0,0,0.7);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Header */

.fg-header {
  display: grid;
  grid-template-columns: 80px 1fr 120px;
  padding: 10px 12px 6px;
  background: linear-gradient(#e4dbc8, #d4c5ae);
  border-bottom: 3px solid var(--fg-border-dark);
}

.portrait-slot {
  width: 64px;
  height: 64px;
  border-radius: 6px;
  background: #c2b5a6;
  border: 3px inset #a1917f;
}

.label-row {
  font-size: 11px;
  letter-spacing: 0.16em;
  color: var(--fg-text-muted);
}

.field-row {
  margin-top: 4px;
}

.field {
  min-height: 20px;
  padding: 2px 6px;
  border-radius: 3px;
  border: 1px solid var(--fg-border-light);
  background: #f4efe4;
  box-shadow: inset 0 0 0 1px #fdf9f0;
  font-size: 13px;
}

.field-long {
  width: 100%;
}

.field.small {
  width: 60px;
}

.field.tiny {
  width: 46px;
}

.fg-header-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  justify-content: space-between;
}

.insp-button {
  padding: 3px 10px;
  border-radius: 4px;
  border: 2px solid var(--fg-border-dark);
  background: radial-gradient(circle at top, #f0e5cf, #d3b792);
  font-size: 12px;
  font-weight: 600;
}

.insp-dots span {
  display: inline-block;
  width: 8px;
  height: 8px;
  margin-left: 2px;
  border-radius: 50%;
  border: 1px solid var(--fg-border-dark);
  background: #f7f2e7;
}

/* Main area */

.fg-layout {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 44px;
  overflow: hidden;
}

.fg-main {
  height: 100%;
}

/* Vertical tabs */

.fg-tabs-vertical {
  background: #c0af92;
  border-left: 3px solid var(--fg-border-dark);
  display: flex;
  flex-direction: column;
  align-items: stretch;
  padding-top: 40px;
  grid-column: 2;
}

.tab-button {
  writing-mode: vertical-rl;
  transform: rotate(180deg);
  border: none;
  background: transparent;
  color: #302217;
  font-size: 11px;
  letter-spacing: 0.12em;
  padding: 10px 0;
  cursor: pointer;
  border-top: 1px solid rgba(0,0,0,0.15);
  border-bottom: 1px solid rgba(255,255,255,0.4);
}

.tab-button.active {
  background: #dfd0b7;
  font-weight: 600;
}

/* Sheet */

.fg-sheet {
  position: relative;
  background: var(--fg-bg);
  padding: 8px 12px 12px;
  overflow: auto;
  grid-column: 1;
}

.toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 6px;
}

.top-info {
  display: grid;
  grid-template-columns: 1fr;
  gap: 6px;
  margin-bottom: 8px;
}

.tab-content.active > .info-strip {
  margin-bottom: 10px;
}

.panel-abilities .panel-header,
.panel-skills .panel-header,
.panel-inventory .panel-header,
.panel-actions .panel-header,
.panel:not(.panel-abilities):not(.panel-saves):not(.panel-skills):not(.panel-actions):not(.panel-inventory) .panel-header {
  font-size: 15px;
}

.panel-skills .panel-header,
.panel-abilities .panel-header {
  letter-spacing: 0.2em;
  text-align: center;
  justify-content: center;
}

.panel-actions .panel-header {
  text-align: left;
}

.skills-header,
.ability-header,
.inventory-header,
.powers-header {
  display: grid;
  padding: 8px 12px;
  border-bottom: 1px solid #b9a88f;
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.2em;
  color: var(--fg-text-muted);
  text-transform: uppercase;
  align-items: center;
}

.skills-header {
  grid-template-columns: 1fr 60px 60px 80px;
}

.skills-col-name {
  padding-left: 18px;
}

.skills-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
}

.skill-row {
  display: grid;
  grid-template-columns: 1fr 60px 60px 80px;
  grid-auto-rows: auto;
  align-items: center;
  justify-items: stretch;
  padding: 6px 10px;
  gap: 8px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
  cursor: pointer;
}

.skill-row:nth-child(odd) {
  background: rgba(0,0,0,0.03);
}

.skill-row:hover {
  background: rgba(0,0,0,0.08);
}

.skill-name {
  display: flex;
  align-items: center;
  gap: 6px;
  justify-self: stretch;
  text-align: left;
}

.skill-icon {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  border: 1px solid #8c7b5f;
  background: #e8dfcf;
}

.skill-label {
  font-size: 13px;
  text-align: left;
}

.skill-stat,
.skill-misc {
  font-size: 12px;
  color: var(--fg-text-muted);
  text-align: center;
}

.skill-total {
  justify-self: center;
  min-width: 60px;
  font-weight: 600;
}

.inventory-header {
  grid-template-columns: 1.5fr 1fr 1fr 60px;
}

.inventory-header span:last-child {
  text-align: center;
  padding-right: 0;
}

.inventory-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
}

.inventory-row {
  display: grid;
  grid-template-columns: 1.5fr 1fr 1fr 60px;
  align-items: center;
  justify-items: stretch;
  padding: 6px 10px;
  gap: 8px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
  cursor: pointer;
}

.inventory-row:nth-child(odd) {
  background: rgba(0,0,0,0.03);
}

.inventory-row:hover {
  background: rgba(0,0,0,0.08);
}

.inventory-name {
  display: flex;
  align-items: center;
  gap: 6px;
  width: 100%;
  text-align: left;
}

.inventory-count {
  font-weight: 600;
  font-size: 12px;
}

.inventory-type,
.inventory-loc,
.inventory-weight {
  font-size: 12px;
  color: var(--fg-text-muted);
}

.inventory-weight {
  text-align: center;
  font-weight: 600;
  padding-right: 0;
}

.inventory-detail {
  grid-column: 1 / -1;
  display: none;
  margin-top: 4px;
  padding: 6px 8px;
  background: #f3ead8;
  border-radius: 4px;
  font-size: 12px;
  color: var(--fg-text-main);
}

.inventory-row.expanded .inventory-detail {
  display: block;
}

.powers-header {
  grid-template-columns: 1.2fr 100px 1fr;
}

.powers-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
}

.power-row {
  display: grid;
  grid-template-columns: 1.2fr 100px 1fr;
  align-items: center;
  justify-items: stretch;
  padding: 6px 10px;
  gap: 8px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
  cursor: pointer;
}

.power-row:nth-child(odd) {
  background: rgba(0,0,0,0.03);
}

.power-row:hover {
  background: rgba(0,0,0,0.08);
}

.power-name {
  font-size: 13px;
  font-weight: 600;
  justify-self: stretch;
  text-align: left;
}

.power-level {
  font-size: 12px;
  color: var(--fg-text-muted);
  text-align: center;
}


.power-note {
  font-size: 12px;
  color: var(--fg-text-muted);
  text-align: center;
}

.power-detail {
  grid-column: 1 / -1;
  display: none;
  margin-top: 4px;
  padding: 6px 8px;
  background: #f3ead8;
  border-radius: 4px;
  font-size: 12px;
  color: var(--fg-text-main);
}

.power-row.expanded .power-detail {
  display: block;
}

.power-row-static {
  cursor: default;
}

.skill-detail {
  grid-column: 1 / -1;
  display: none;
  margin-top: 4px;
  padding: 6px 8px;
  background: #f3ead8;
  border-radius: 4px;
  font-size: 12px;
  color: var(--fg-text-main);
}

.skill-row.expanded .skill-detail {
  display: block;
}

.file-input-label {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  background: #b59163;
  color: #fff7e4;
  border-radius: 4px;
  border: 1px solid #614628;
  font-size: 13px;
  cursor: pointer;
}

.file-input-label input {
  display: none;
}

.file-status {
  font-size: 12px;
  color: var(--fg-text-muted);
}

.panel {
  border-radius: 4px;
  border: 2px solid var(--fg-border-dark);
  background: var(--fg-bg-inner);
  box-shadow: 0 1px 0 #fff5e7 inset;
  margin-bottom: 8px;
}

.panel-header {
  padding: 6px 10px;
  background: var(--fg-panel-header-bg);
  border-bottom: 1px solid var(--fg-border-dark);
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.24em;
  color: #4c371f;
  text-transform: uppercase;
}

.panel-body {
  padding: 6px 8px;
}

.main-layout {
  display: grid;
  grid-template-columns: 190px minmax(0, 1fr) 150px;
  gap: 10px;
  align-items: stretch;
}

.main-abilities,
.main-saves {
  margin-top: 6px;
}

.main-center {
  background: #d9d1c4;
  border: 2px solid var(--fg-border-dark);
  border-radius: 6px;
  padding: 10px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
  display: flex;
  flex-direction: column;
  justify-content: space-evenly;
  height: 100%;
}

.info-strip {
  display: flex;
  gap: 8px;
  align-items: stretch;
  background: #c9c0b2;
  border: 1px solid var(--fg-border-dark);
  border-radius: 4px;
  padding: 4px 6px;
}

.main-center {
  margin-top: 6px;
}

.strip-block {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}

.strip-grow {
  flex: 1;
}

.strip-label {
  font-size: 11px;
  letter-spacing: 0.2em;
  color: var(--fg-text-main);
  font-weight: 700;
}

.strip-content {
  display: flex;
  align-items: center;
  gap: 6px;
}

.strip-value {
  font-size: 14px;
  font-weight: 600;
}

.strip-value-small {
  font-size: 12px;
}

.strip-divider {
  flex: 0 0 1px;
  height: 14px;
  background: rgba(0,0,0,0.2);
}

.strip-pill .field-pill,
.strip-block .field.field-pill {
  min-width: 50px;
  text-align: center;
  font-weight: 600;
}

.field-line {
  width: 100%;
}

.strip-placeholder {
  min-height: 20px;
  border: 1px dashed rgba(0,0,0,0.2);
  border-radius: 3px;
  padding: 4px 6px;
  font-size: 12px;
  color: var(--fg-text-muted);
}

.stat-row {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.stat-card {
  flex: 0 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 4px 10px;
  border: 1px solid var(--fg-border-light);
  border-radius: 6px;
  background: #f5f0e7;
}

.stat-label {
  font-size: 11px;
  letter-spacing: 0.16em;
  color: var(--fg-text-muted);
}

.stat-field {
  min-width: 48px;
  text-align: center;
  font-size: 14px;
  font-weight: 500;
}

.note-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.note-block {
  background: #ece6d9;
  border: 1px solid var(--fg-border-light);
  border-radius: 4px;
  padding: 4px 6px;
}

.note-label {
  font-size: 10px;
  letter-spacing: 0.14em;
  color: var(--fg-text-muted);
  margin-bottom: 4px;
}

.note-line {
  height: 1px;
  background: rgba(0,0,0,0.3);
}

.hp-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.hp-track-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 14px;
  border: 2px solid var(--fg-border-dark);
  border-radius: 999px;
  background: linear-gradient(#b4a388, #998970);
  color: #f7f2ec;
  font-size: 11px;
  letter-spacing: 0.2em;
}

.hp-track-label {
  flex: 1;
  text-align: center;
}

.hp-stats {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  align-items: center;
  justify-content: center;
}

.hp-stat {
  display: flex;
  align-items: center;
  gap: 6px;
}

.hp-stat-label {
  font-size: 11px;
  letter-spacing: 0.16em;
  color: var(--fg-text-muted);
}

.death-save .hp-stat-label {
  font-size: 9px;
  letter-spacing: 0.12em;
}

.hp-stat-fields {
  display: flex;
  gap: 8px;
}

.hp-field,
.hp-total {
  width: 48px;
  min-height: 26px;
  text-align: center;
  font-weight: 500;
}

.hp-total {
  width: 56px;
}

.hp-field-small {
  width: 38px;
}

.hp-field-hd {
  width: 90px;
  font-size: 11px;
}

.hp-panel {
  margin-top: 10px;
  padding: 8px 10px;
  border: 2px solid var(--fg-border-dark);
  border-radius: 6px;
  background: #dcd4c7;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
}

.death-save {
  margin-left: auto;
  align-items: center;
}

.death-track {
  display: flex;
  align-items: center;
  gap: 4px;
}

.death-save-fields {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.death-label {
  font-size: 9px;
  letter-spacing: 0.08em;
  color: var(--fg-text-muted);
}

.death-dots {
  display: flex;
  gap: 4px;
}

.death-dots span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  border: 1px solid var(--fg-border-light);
  background: #fdf9f0;
}

.main-abilities,
.main-saves {
  height: fit-content;
}

.panel-saves .panel-header {
  text-align: center;
}

.saves-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 8px;
}

.save {
  display: flex;
  align-items: center;
  gap: 8px;
}

.save-label {
  font-size: 11px;
  letter-spacing: 0.14em;
  color: var(--fg-text-muted);
  min-width: 32px;
}

.save .field-pill {
  min-width: 56px;
  text-align: center;
  font-weight: 600;
}

/* Abilities */

.panel-abilities .panel-body {
  padding: 4px;
}

.abilities-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 4px;
  padding: 4px;
}

.ability {
  display: grid;
  grid-template-columns: 42px 1fr 40px;
  align-items: center;
  gap: 4px;
}

.ability-label {
  font-size: 11px;
  font-weight: 600;
  text-align: center;
}

.ability-score {
  text-align: center;
  padding: 2px 0;
  border-radius: 4px;
  border: 1px solid var(--fg-border-light);
  background: #f6efe3;
  font-size: 13px;
}

.ability-mod {
  text-align: center;
  padding: 2px 0;
  border-radius: 999px;
  border: 2px solid var(--fg-border-dark);
  background: #f9f4ea;
  font-size: 12px;
}

/* Core stats */

.core-grid {
  padding: 4px 8px 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.core-row {
  display: grid;
  grid-template-columns: auto minmax(0, 1.4fr) auto minmax(0, 1fr);
  column-gap: 8px;
  row-gap: 4px;
  align-items: center;
}

.core-row.core-row-main {
  grid-template-columns: auto minmax(0, 1fr) auto 64px;
}

.core-row.core-row-stats,
.core-row.core-row-health {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.core-label {
  font-size: 11px;
  color: var(--fg-text-muted);
}

.core-row.core-row-stats .core-label,
.core-row.core-row-health .core-label {
  font-size: 10px;
  letter-spacing: 0.08em;
}

.core-stat {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  min-width: 50px;
}

.core-row.core-row-stats .field.tiny,
.core-row.core-row-health .field.tiny {
  width: auto;
  min-width: 44px;
  text-align: center;
  font-weight: 600;
  padding: 2px 6px;
}

/* Tables */

.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.table thead {
  background: #d1c1a7;
}

.table th,
.table td {
  padding: 4px 6px;
  border-bottom: 1px solid #c3b39a;
}

.table tbody tr:nth-child(even) {
  background: rgba(255,255,255,0.4);
}

.table-weapons th:nth-child(1) { width: 40%; }
.table-weapons th:nth-child(2) { width: 12%; }
.table-weapons th:nth-child(3) { width: 24%; }

.table-skills th:nth-child(1) { width: 50%; }
.table-skills th:nth-child(2) { width: 10%; }
.table-skills th:nth-child(3) { width: 10%; }

.table-skills tbody tr {
  cursor: pointer;
}

.table-skills tbody tr:hover {
  background: rgba(255,255,255,0.7);
}


.detail-row td.detail-cell {
  background: transparent;
  padding: 0;
}

.detail-card {
  margin: 6px 0;
  background: #f3ead8;
  border: 1px solid #c3b39a;
  border-radius: 6px;
  padding: 10px 12px;
  font-size: 12px;
  color: var(--fg-text-main);
}

.detail-row p {
  margin: 4px 0;
}

.detail-title {
  font-weight: 600;
}

.detail-header {
  font-size: 12px;
  color: var(--fg-text-muted);
  margin-bottom: 4px;
}

.detail-body {
  margin-top: 2px;
}

/* Inventory */

.table-inventory th:nth-child(1) { width: 6%; }
.table-inventory th:nth-child(2) { width: 46%; }
.table-inventory th:nth-child(3) { width: 20%; }
.table-inventory th:nth-child(4) { width: 14%; }
.table-inventory th:nth-child(5) { width: 14%; }

.coins-row {
  display: flex;
  gap: 10px;
  padding: 8px;
  font-size: 13px;
}

.coins-row .coin {
  display: flex;
  align-items: center;
  gap: 4px;
}

/* Lists / text areas */

.text-list {
  list-style: none;
  margin: 0;
  padding: 6px 8px 8px;
  max-height: 140px;
  overflow: auto;
  font-size: 13px;
}

.text-list li + li {
  margin-top: 4px;
}

.text-list .item-name {
  font-weight: 600;
  cursor: pointer;
}

.text-list .item-text {
  display: block;
  color: var(--fg-text-muted);
  font-size: 12px;
}

.notes-content {
  padding: 8px;
  font-size: 13px;
  white-space: pre-wrap;
}

.notes-content.empty {
  color: var(--fg-text-muted);
}

/* Tabs content */

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Responsive tweaks */

@media (max-width: 900px) {
  .app-root {
    height: 100vh;
    border-radius: 0;
  }

  .panel-row.top-row {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>
  <div class="app-root">
    <header class="fg-header">
      <div class="fg-header-left">
        <div class="portrait-slot"></div>
      </div>
      <div class="fg-header-center">
        <div class="label-row">
          <span class="label">NAME</span>
        </div>
        <div class="field-row">
          <div id="char-name" class="field field-long"></div>
        </div>
      </div>
    </header>

    <div class="fg-layout">
      <main class="fg-main">
        <section class="fg-sheet">
        <div class="toolbar">
          <label class="file-input-label">
            Load XML
            <input type="file" id="xmlInput" accept=".xml" />
          </label>
          <span id="file-status" class="file-status">No file loaded</span>
        </div>

        <div class="top-info">
          <div class="info-strip strip-col">
            <div class="strip-block strip-grow">
              <div class="strip-label">CLASS &amp; LEVEL</div>
              <div class="strip-content">
                <span id="char-class" class="strip-value"></span>
                <span class="strip-divider"></span>
                <span id="char-level" class="strip-value strip-value-small"></span>
              </div>
            </div>
            <div class="strip-block strip-pill">
              <div class="strip-label">PROF</div>
              <div id="char-prof" class="field field-pill"></div>
            </div>
          </div>
        </div>

        <div class="tab-content active" id="tab-main">
          <div class="info-strip strip-col">
            <div class="strip-block strip-grow">
              <div class="strip-label">BACKGROUND</div>
              <div id="char-background" class="field field-line"></div>
            </div>
            <div class="strip-block">
              <div class="strip-label">SPECIES</div>
              <div id="char-race" class="field field-line"></div>
            </div>
          </div>
          <div class="main-layout">
            <section class="panel panel-abilities main-abilities">
              <div class="panel-header">ABILITIES</div>
              <div class="abilities-grid">
                <div class="ability" data-ability="strength">
                  <div class="ability-label">STR</div>
                  <div class="ability-score" data-field="score"></div>
                  <div class="ability-mod" data-field="bonus"></div>
                </div>
                <div class="ability" data-ability="dexterity">
                  <div class="ability-label">DEX</div>
                  <div class="ability-score" data-field="score"></div>
                  <div class="ability-mod" data-field="bonus"></div>
                </div>
                <div class="ability" data-ability="constitution">
                  <div class="ability-label">CON</div>
                  <div class="ability-score" data-field="score"></div>
                  <div class="ability-mod" data-field="bonus"></div>
                </div>
                <div class="ability" data-ability="intelligence">
                  <div class="ability-label">INT</div>
                  <div class="ability-score" data-field="score"></div>
                  <div class="ability-mod" data-field="bonus"></div>
                </div>
                <div class="ability" data-ability="wisdom">
                  <div class="ability-label">WIS</div>
                  <div class="ability-score" data-field="score"></div>
                  <div class="ability-mod" data-field="bonus"></div>
                </div>
                <div class="ability" data-ability="charisma">
                  <div class="ability-label">CHA</div>
                  <div class="ability-score" data-field="score"></div>
                  <div class="ability-mod" data-field="bonus"></div>
                </div>
              </div>
            </section>

            <div class="main-column">
              <div class="main-center">
                <div class="info-strip senses-strip">
                  <div class="strip-block strip-grow">
                    <div class="strip-label">SENSES</div>
                    <div class="strip-placeholder">Passive Perception</div>
                  </div>
                  <div class="strip-block strip-pill">
                    <div class="strip-label">PERC</div>
                    <div id="char-perception" class="field field-pill"></div>
                  </div>
                </div>

                <div class="stat-row">
                  <div class="stat-card">
                    <span class="stat-label">HP</span>
                    <div id="char-hp" class="field hp-total"></div>
                  </div>
                  <div class="stat-card">
                    <span class="stat-label">AC</span>
                    <div id="char-ac" class="field stat-field"></div>
                  </div>
                  <div class="stat-card">
                    <span class="stat-label">INIT</span>
                    <div id="char-init" class="field stat-field"></div>
                  </div>
                  <div class="stat-card">
                    <span class="stat-label">SPEED</span>
                    <div id="char-speed" class="field stat-field"></div>
                  </div>
                </div>

                <div class="note-row">
                  <div class="note-block">
                    <div class="note-label">SPECIAL MOVE</div>
                    <div class="note-line"></div>
                  </div>
                  <div class="note-block">
                    <div class="note-label">SPECIAL DEFENSES</div>
                    <div class="note-line"></div>
                  </div>
                </div>

              </div>
            </div>

            <aside class="panel panel-saves main-saves">
              <div class="panel-header">SAVES</div>
              <div class="saves-list">
                <div class="save" data-save="strength">
                  <span class="save-label">STR</span>
                  <div id="save-str" class="field field-pill"></div>
                </div>
                <div class="save" data-save="dexterity">
                  <span class="save-label">DEX</span>
                  <div id="save-dex" class="field field-pill"></div>
                </div>
                <div class="save" data-save="constitution">
                  <span class="save-label">CON</span>
                  <div id="save-con" class="field field-pill"></div>
                </div>
                <div class="save" data-save="intelligence">
                  <span class="save-label">INT</span>
                  <div id="save-int" class="field field-pill"></div>
                </div>
                <div class="save" data-save="wisdom">
                  <span class="save-label">WIS</span>
                  <div id="save-wis" class="field field-pill"></div>
                </div>
                <div class="save" data-save="charisma">
                  <span class="save-label">CHA</span>
                  <div id="save-cha" class="field field-pill"></div>
                </div>
              </div>
            </aside>
          </div>
        </div>

        <div class="tab-content" id="tab-skills">
          <section class="panel panel-skills">
            <div class="panel-header">SKILLS</div>
            <div class="skills-header">
              <span class="skills-heading skills-col-name">NAME</span>
              <span class="skills-heading">STAT</span>
              <span class="skills-heading">PROF</span>
              <span class="skills-heading">TOTAL</span>
            </div>
            <ul id="skills-body" class="skills-list"></ul>
          </section>
        </div>

        <div class="tab-content abilities-tab" id="tab-abilities">
          <div class="abilities-stack">
            <section class="panel ability-panel">
              <div class="panel-header">FEATS</div>
              <div class="ability-header">
                <span class="abilities-heading abilities-col-name">NAME</span>
                <span class="abilities-heading">DETAILS</span>
              </div>
              <ul id="feats-list" class="ability-list"></ul>
            </section>

            <section class="panel ability-panel">
              <div class="panel-header">FEATURES</div>
              <div class="ability-header">
                <span class="abilities-heading abilities-col-name">NAME</span>
                <span class="abilities-heading">DETAILS</span>
              </div>
              <ul id="features-list" class="ability-list"></ul>
            </section>

            <section class="panel ability-panel">
              <div class="panel-header">TRAITS</div>
              <div class="ability-header">
                <span class="abilities-heading abilities-col-name">NAME</span>
                <span class="abilities-heading">DETAILS</span>
              </div>
              <ul id="traits-list" class="ability-list"></ul>
            </section>

            <section class="panel ability-panel">
              <div class="panel-header">PROFICIENCIES</div>
              <div class="ability-header">
                <span class="abilities-heading abilities-col-name">NAME</span>
                <span class="abilities-heading">NOTES</span>
              </div>
              <ul id="profs-list" class="ability-list"></ul>
            </section>

            <section class="panel ability-panel">
              <div class="panel-header">LANGUAGES</div>
              <div class="ability-header">
                <span class="abilities-heading abilities-col-name">NAME</span>
                <span class="abilities-heading">NOTES</span>
              </div>
              <ul id="languages-list" class="ability-list"></ul>
            </section>
          </div>
        </div>

        <div class="tab-content" id="tab-inventory">
          <section class="panel panel-inventory">
            <div class="panel-header">EQUIPMENT</div>
            <div class="inventory-header">
              <span class="inventory-heading inventory-col-name">ITEM</span>
              <span class="inventory-heading">TYPE</span>
              <span class="inventory-heading">LOCATION</span>
              <span class="inventory-heading">WT</span>
            </div>
            <ul id="inventory-body" class="inventory-list"></ul>
          </section>
          <section class="panel">
            <div class="panel-header">TREASURE</div>
            <div class="coins-row" id="coins-row"></div>
          </section>
        </div>

        <div class="tab-content" id="tab-notes">
          <section class="panel">
            <div class="panel-header">NOTES</div>
            <div id="notes-content" class="notes-content empty">No narrative notes in this export.</div>
          </section>
        </div>

        <div class="tab-content" id="tab-actions">
          <section class="panel panel-actions">
            <div class="panel-header">ACTIONS / POWERS</div>
            <ul id="actions-body" class="powers-list"></ul>
          </section>
          <section class="panel">
            <div class="panel-header">WEAPONS</div>
            <div class="panel-body">
              <table class="table table-weapons">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Attack</th>
                    <th>Damage</th>
                    <th>Properties</th>
                  </tr>
                </thead>
                <tbody id="weapons-body"></tbody>
              </table>
            </div>
          </section>
          <section class="panel">
            <div class="panel-header">SPELLS</div>
            <div class="spell-groups" id="spells-main"></div>
          </section>
        </div>
      </section>
      </main>

      <nav class="fg-tabs-vertical">
        <button class="tab-button active" data-tab="main">Main</button>
        <button class="tab-button" data-tab="skills">Skills</button>
        <button class="tab-button" data-tab="abilities">Abilities</button>
        <button class="tab-button" data-tab="inventory">Inventory</button>
        <button class="tab-button" data-tab="notes">Notes</button>
        <button class="tab-button" data-tab="actions">Actions</button>
      </nav>
    </div>
  </div>

  <script>// Simple Fantasy Grounds character viewer for exported XML

function $(selector) {
  return document.querySelector(selector);
}

function $all(selector) {
  return Array.from(document.querySelectorAll(selector));
}

function textOf(node, selector, fallback = "") {
  const el = selector ? node.querySelector(selector) : node;
  return el && el.textContent != null ? el.textContent : fallback;
}

function numberOf(node, selector, fallback = 0) {
  const t = textOf(node, selector, "").trim();
  const n = Number(t);
  return Number.isFinite(n) ? n : fallback;
}

function formatSigned(value) {
  const n = Number(value);
  if (!Number.isFinite(n)) return "";
  if (n === 0) return "+0";
  return n > 0 ? `+${n}` : String(n);
}

function normalizeBackgroundName(value) {
  if (!value) return "";
  const trimmed = value.trim();
  if (!trimmed) return "";
  if (/^reference\.backgrounddata/i.test(trimmed)) {
    return "";
  }
  return trimmed;
}

const ABILITY_SHORT = {
  strength: "str",
  dexterity: "dex",
  constitution: "con",
  intelligence: "int",
  wisdom: "wis",
  charisma: "cha",
};

const SKILL_DISPLAY_ORDER = [
  "Acrobatics",
  "Animal Handling",
  "Arcana",
  "Athletics",
  "Deception",
  "History",
  "Insight",
  "Intimidation",
  "Investigation",
  "Medicine",
  "Nature",
  "Perception",
  "Performance",
  "Persuasion",
  "Religion",
  "Sleight of Hand",
  "Stealth",
  "Survival",
];

const SKILL_ORDER_MAP = SKILL_DISPLAY_ORDER.reduce((acc, name, index) => {
  acc[name.toLowerCase()] = index;
  return acc;
}, {});

const SKILL_DESCRIPTIONS = {
  "Acrobatics": "Your Dexterity (Acrobatics) check covers your attempt to stay on your feet in a tricky situation, such as when you're trying to run across a sheet of ice, balance on a tightrope, or stay upright on a rocking ship's deck. The DM might also call for a Dexterity (Acrobatics) check to see if you can perform acrobatic stunts, including dives, rolls, somersaults, and flips.",
  "Animal Handling": "When there is any question whether you can calm down a domesticated animal, keep a mount from getting spooked, or intuit an animal's intentions, the DM might call for a Wisdom (Animal Handling) check. You also make a Wisdom (Animal Handling) check to control your mount when you attempt a risky maneuver.",
  "Arcana": "Your Intelligence (Arcana) check measures your ability to recall lore about spells, magic items, eldritch symbols, magical traditions, the planes of existence, and the inhabitants of those planes.",
  "Athletics": "Your Strength (Athletics) check covers difficult situations you encounter while climbing, jumping, or swimming.",
  "Deception": "Your Charisma (Deception) check determines whether you can convincingly hide the truth, either verbally or through your actions. This deception can encompass everything from misleading others through ambiguity to telling outright lies. Typical situations include trying to fast-talk a guard, con a merchant, earn money through gambling, pass yourself off in a disguise, dull someone's suspicions with false assurances, or maintain a straight face while telling a blatant lie.",
  "History": "Your Intelligence (History) check measures your ability to recall lore about historical events, legendary people, ancient kingdoms, past disputes, recent wars, and lost civilizations.",
  "Insight": "Your Wisdom (Insight) check decides whether you can determine the true intentions of a creature, such as when searching out a lie or predicting someone's next move. Doing so involves gleaning clues from body language, speech habits, and changes in mannerisms.",
  "Intimidation": "When you attempt to influence someone through overt threats, hostile actions, and physical violence, the DM might ask you to make a Charisma (Intimidation) check. Examples include trying to pry information out of a prisoner, convincing street thugs to back down from a confrontation, or using the edge of a broken bottle to convince a sneering vizier to reconsider a decision.",
  "Investigation": "When you look around for clues and make deductions based on those clues, you make an Intelligence (Investigation) check. You might deduce the location of a hidden object, discern from the appearance of a wound what kind of weapon dealt it, or determine the weakest point in a tunnel that could cause it to collapse. Poring through ancient scrolls in search of a hidden fragment of knowledge might also call for an Intelligence (Investigation) check.",
  "Medicine": "A Wisdom (Medicine) check lets you try to stabilize a dying companion or diagnose an illness.",
  "Nature": "Your Intelligence (Nature) check measures your ability to recall lore about terrain, plants and animals, the weather, and natural cycles.",
  "Perception": "Your Wisdom (Perception) check lets you spot, hear, or otherwise detect the presence of something. It measures your general awareness of your surroundings and the keenness of your senses. For example, you might try to hear a conversation through a closed door, eavesdrop under an open window, or hear monsters moving stealthily in the forest. Or you might try to spot things that are obscured or easy to miss, whether they are orcs lying in ambush on a road, thugs hiding in the shadows of an alley, or candlelight under a closed secret door.",
  "Performance": "Your Charisma (Performance) check determines how well you can delight an audience with music, dance, acting, storytelling, or some other form of entertainment.",
  "Persuasion": "When you attempt to influence someone or a group of people with tact, social graces, or good nature, the DM might ask you to make a Charisma (Persuasion) check. Typically, you use persuasion when acting in good faith, to foster friendships, make cordial requests, or exhibit proper etiquette. Examples of persuading others include convincing a chamberlain to let your party see the king, negotiating peace between warring tribes, or inspiring a crowd of townsfolk.",
  "Religion": "Your Intelligence (Religion) check measures your ability to recall lore about deities, rites and prayers, religious hierarchies, holy symbols, and the practices of secret cults.",
  "Sleight of Hand": "Whenever you attempt an act of legerdemain or manual trickery, such as planting something on someone else or concealing an object on your person, make a Dexterity (Sleight of Hand) check. The DM might also call for a Dexterity (Sleight of Hand) check to determine whether you can lift a coin purse off another person or slip something out of another person's pocket.",
  "Stealth": "Make a Dexterity (Stealth) check when you attempt to conceal yourself from enemies, slink past guards, slip away without being noticed, or sneak up on someone without being seen or heard.",
  "Survival": "The DM might ask you to make a Wisdom (Survival) check to follow tracks, hunt wild game, guide your group through frozen wastelands, identify signs that owlbears live nearby, predict the weather, or avoid quicksand and other natural hazards.",
};

function groupChildren(node) {
  const result = [];
  node && node.childNodes.forEach((child) => {
    if (child.nodeType === 1) {
      result.push(child);
    }
  });
  return result;
}

function toggleDetailRow(row, colSpan, html) {
  const next = row.nextElementSibling;
  if (next && next.classList.contains("detail-row")) {
    next.remove();
    row.classList.remove("expanded");
    return;
  }
  const detail = document.createElement("tr");
  detail.className = "detail-row";
  detail.innerHTML = `<td colspan="${colSpan}" class="detail-cell"><div class="detail-card">${html}</div></td>`;
  row.parentElement.insertBefore(detail, row.nextSibling);
  row.classList.add("expanded");
}

function getSkillDescription(name) {
  if (!name) return "Checks with this skill use one of your abilities and may be modified by proficiency and circumstances.";
  return SKILL_DESCRIPTIONS[name] || "Checks with this skill use one of your abilities and may be modified by proficiency and circumstances.";
}

function readableAbilityName(statKey) {
  const key = (statKey || "").toLowerCase();
  const map = {
    strength: "Strength",
    dexterity: "Dexterity",
    constitution: "Constitution",
    intelligence: "Intelligence",
    wisdom: "Wisdom",
    charisma: "Charisma",
  };
  return map[key] || statKey || "";
  return statKey || "";
}

function getSpellDescription(name, powerNode) {
  const spells = (window.Descriptions && window.Descriptions.spells) || {};
  if (spells[name]) return spells[name];
  if (powerNode) {
    const descNode = powerNode.querySelector("description");
    if (descNode) return descNode.textContent.replace(/\s+/g, " ").trim();
  }
  return "No additional description for this spell in this export.";
}

function getItemDescription(name, itemNode) {
  const items = (window.Descriptions && window.Descriptions.items) || {};
  if (items[name]) return items[name];
  if (itemNode) {
    const descNode = itemNode.querySelector("description");
    if (descNode) return descNode.textContent.replace(/\s+/g, " ").trim();
  }
  return "No additional description for this item in this export.";
}

function handleFileSelect(evt) {
  const file = evt.target.files && evt.target.files[0];
  if (!file) return;

  const status = $("#file-status");
  status.textContent = `Loading ${file.name} ...`;

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const xmlText = e.target.result;
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, "text/xml");
      const char = xmlDoc.querySelector("root > character");
      if (!char) {
        status.textContent = "No <character> element found.";
        return;
      }
      renderCharacter(char);
      status.textContent = `Loaded ${file.name}`;
    } catch (err) {
      console.error(err);
      status.textContent = "Failed to parse XML";
    }
  };
  reader.onerror = () => {
    $("#file-status").textContent = "Error reading file";
  };
  reader.readAsText(file);
}

function renderCharacter(char) {
  // Header
  const charNameNode = char.querySelector(":scope > name");
  $("#char-name").textContent = charNameNode ? charNameNode.textContent : "";

  const classNode = char.querySelector("classes > *");
  $("#char-class").textContent = classNode ? textOf(classNode, "name") : "";
  $("#char-level").textContent = classNode ? numberOf(classNode, "level") : numberOf(char, "level");

  $("#char-race").textContent = textOf(char, "racename") || textOf(char, "race");
  const rawBackground = textOf(char, "backgroundlink > recordname");
  $("#char-background").textContent = normalizeBackgroundName(rawBackground);

  const hpNode = char.querySelector("hp");
  const hpWounds = hpNode ? numberOf(hpNode, "wounds", NaN) : NaN;
  const hpTotal = hpNode ? numberOf(hpNode, "total", NaN) : NaN;
  const hpTemp = hpNode ? numberOf(hpNode, "temporary", NaN) : NaN;
  const currentHp = Number.isFinite(hpTotal) && Number.isFinite(hpWounds) ? hpTotal - hpWounds : hpTotal;

  const setHpField = (selector, value) => {
    const el = $(selector);
    if (el) {
      el.textContent = Number.isFinite(value) ? value : "";
    }
  };

  $("#char-hp").textContent = Number.isFinite(currentHp) ? currentHp : "";
  setHpField("#hp-max", hpTotal);
  setHpField("#hp-wounds", hpWounds);
  setHpField("#hp-temp", hpTemp);

  const acNode = char.querySelector("defenses > ac");
  $("#char-ac").textContent = acNode ? numberOf(acNode, "total") : "";

  const initNode = char.querySelector("initiative");
  $("#char-init").textContent = initNode ? numberOf(initNode, "total") : "";

  const speedNode = char.querySelector("speed");
  $("#char-speed").textContent = speedNode ? numberOf(speedNode, "total") : "";

  $("#char-perception").textContent = numberOf(char, "perception");
  $("#char-prof").textContent = numberOf(char, "profbonus");

  const classHd = classNode ? textOf(classNode, "hddie") : "";
  const classHdUsed = classNode ? numberOf(classNode, "hdused") : 0;
  const charHdEl = $("#char-hd");
  if (charHdEl) {
    charHdEl.textContent = classHd ? `${classHd} (${classHdUsed} used)` : "";
  }

  // Abilities
  const abilitiesNode = char.querySelector("abilities");
  if (abilitiesNode) {
    $all(".ability").forEach((el) => {
      const abilityKey = el.getAttribute("data-ability");
      const dataNode = abilitiesNode.querySelector(abilityKey);
      const scoreEl = el.querySelector(".ability-score");
      const modEl = el.querySelector(".ability-mod");
      const saveEl = $("#save-" + (ABILITY_SHORT[abilityKey] || abilityKey));
      if (dataNode) {
        const score = numberOf(dataNode, "score");
        const bonus = numberOf(dataNode, "bonus");
        scoreEl.textContent = score || "";
        modEl.textContent = bonus >= 0 ? `+${bonus}` : String(bonus);
        if (saveEl) {
          const saveValue = numberOf(dataNode, "save", NaN);
          saveEl.textContent = formatSigned(saveValue);
        }
      } else {
        scoreEl.textContent = "";
        modEl.textContent = "";
        if (saveEl) {
          saveEl.textContent = "";
        }
      }
    });
  }

  // Weapons (weaponlist)
  const weaponsBody = $("#weapons-body");
  weaponsBody.innerHTML = "";
  const weaponList = char.querySelector("weaponlist");
  if (weaponList) {
    groupChildren(weaponList).forEach((item) => {
      const tr = document.createElement("tr");
      const name = textOf(item, "name");
      const atk = numberOf(item, "attackbonus", 0) + numberOf(char, "profbonus", 0);
      const dmgNode = item.querySelector("damagelist > *");
      const dmgDice = dmgNode ? textOf(dmgNode, "dice") : "";
      const dmgType = dmgNode ? textOf(dmgNode, "type") : "";
      const props = textOf(item, "properties");

      tr.innerHTML = `
        <td>${name}</td>
        <td>${atk >= 0 ? "+" + atk : atk}</td>
        <td>${dmgDice ? `${dmgDice} ${dmgType}` : ""}</td>
        <td>${props}</td>
      `;
      weaponsBody.appendChild(tr);
    });
  }

  // Inventory (inventorylist)
  const invBody = $("#inventory-body");
  invBody.innerHTML = "";
  const invList = char.querySelector("inventorylist");
  if (invList) {
    groupChildren(invList).forEach((item) => {
      const count = numberOf(item, "count", 1);
      const name = textOf(item, "name");
      const type = textOf(item, "type");
      const locRaw = numberOf(item, "carried", 0);
      const loc = locRaw === 2 ? "Equipped" : locRaw === 1 ? "Carried" : "Stored";
      const weightEach = numberOf(item, "weight", 0);
      const weightTotal = (count || 1) * weightEach;
      const row = document.createElement("li");
      row.className = "inventory-row";
      row.innerHTML = `
        <div class="inventory-name">
          <span class="inventory-count">${count || 1}</span>
          <span class="inventory-label">${name}</span>
        </div>
        <div class="inventory-type">${type || ""}</div>
        <div class="inventory-loc">${loc}</div>
        <div class="inventory-weight">${weightTotal || 0}</div>
        <div class="inventory-detail"></div>
      `;
      const detailEl = row.querySelector(".inventory-detail");
      row.addEventListener("click", () => {
        if (!detailEl) return;
        if (row.classList.contains("expanded")) {
          row.classList.remove("expanded");
          detailEl.innerHTML = "";
          return;
        }
        const parts = [];
        if (type) parts.push(type);
        const subtype = textOf(item, "subtype");
        if (subtype) parts.push(subtype);
        const cost = textOf(item, "cost");
        if (cost) parts.push(`Cost ${cost}`);
        const weightStr = weightEach ? `${weightEach} ea` : "";
        if (weightStr) parts.push(`Weight ${weightStr}`);
        const headerLine = parts.join(" | ");
        const desc = getItemDescription(name, item);
        detailEl.innerHTML = `
          <div class="detail-title">${name}</div>
          <div class="detail-header">${headerLine}</div>
          <div class="detail-body">${desc}</div>
        `;
        row.classList.add("expanded");
      });
      invBody.appendChild(row);
    });
  }

  // Coins
  const coinsRow = $("#coins-row");
  coinsRow.innerHTML = "";
  const coins = char.querySelector("coins");
  if (coins) {
    groupChildren(coins).forEach((coin) => {
      const name = textOf(coin, "name");
      const amount = numberOf(coin, "amount", 0);
      const span = document.createElement("div");
      span.className = "coin";
      span.innerHTML = `<span>${name}</span><div class="field tiny">${amount}</div>`;
      coinsRow.appendChild(span);
    });
  }

  // Skills
  const skillsBody = $("#skills-body");
  skillsBody.innerHTML = "";
  const skillList = char.querySelector("skilllist");
  const abilitiesForSkills = char.querySelector("abilities");
  const abilityMods = {};
  if (abilitiesForSkills) {
    ["strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma"].forEach((ab) => {
      const n = abilitiesForSkills.querySelector(ab);
      abilityMods[ab] = n ? numberOf(n, "bonus", 0) : 0;
    });
  }
  const profBonus = numberOf(char, "profbonus", 0);
  if (skillList) {
    const skills = groupChildren(skillList).map((skill) => ({
      node: skill,
      name: textOf(skill, "name"),
    }));

    skills.sort((a, b) => {
      const indexA = SKILL_ORDER_MAP[a.name?.toLowerCase()] ?? Number.POSITIVE_INFINITY;
      const indexB = SKILL_ORDER_MAP[b.name?.toLowerCase()] ?? Number.POSITIVE_INFINITY;
      if (indexA !== indexB) return indexA - indexB;
      return (a.name || "").localeCompare(b.name || "");
    });

    skills.forEach(({ node: skill, name }) => {
      const statKey = textOf(skill, "stat");
      const misc = numberOf(skill, "misc");
      const total = numberOf(skill, "total");
      const prof = numberOf(skill, "prof");

      const profLabels = {
        0: " ",
        1: "Proficient",
        2: "Expertise",
        3: "Half Proficent"
      };

      const li = document.createElement("li");
      li.className = "skill-row";
      li.innerHTML = `
        <div class="skill-name">
          <span class="skill-label">${name}</span>
        </div>
        <div class="skill-stat">${statKey}</div>
        <div class="skill-misc">${profLabels[prof]}</div>
        <div class="skill-total">${formatSigned(total)}</div>
        <div class="skill-detail"></div>
      `;
      const detailEl = li.querySelector(".skill-detail");
      li.addEventListener("click", () => {
        if (!detailEl) return;
        if (li.classList.contains("expanded")) {
          li.classList.remove("expanded");
          detailEl.innerHTML = "";
          return;
        }
        const abilityName = readableAbilityName(statKey);
        const abilityKey = (statKey || "").toLowerCase();
        const abilityMod = abilityMods[abilityKey];
        const parts = [];
        parts.push(`Total ${formatSigned(total)}`);
        if (abilityName) {
          if (Number.isFinite(abilityMod)) {
            parts.push(`Ability ${abilityName} ${formatSigned(abilityMod)}`);
          } else {
            parts.push(`Ability ${abilityName}`);
          }
        }
        if (prof) {
          const profTotal = profBonus * prof;
          parts.push(`Proficiency ${formatSigned(profTotal)}`);
        }
        if (misc) {
          parts.push(`Misc ${formatSigned(misc)}`);
        }
        const headerLine = parts.join(" | ");
        const desc = getSkillDescription(name);
        detailEl.innerHTML = `
          <div class="detail-title">${name}</div>
          <div class="detail-header">${headerLine}</div>
          <div class="detail-body">${desc}</div>
        `;
        li.classList.add("expanded");
      });
      skillsBody.appendChild(li);
    });
  }

  // Feats, features, traits, proficiencies, languages
  renderTextList(char, "featlist", "#feats-list");
  renderTextList(char, "featurelist", "#features-list");
  renderTextList(char, "traitlist", "#traits-list");
  renderSimpleList(char, "proficiencylist", "#profs-list");
  renderSimpleList(char, "languagelist", "#languages-list");

  // Powers / actions
  renderPowers(char);

  // Notes: this particular export does not seem to carry personality/notes blocks
  const notes = $("#notes-content");
  if (notes) {
    notes.textContent = "This export does not contain narrative notes (personality, bonds, etc.).";
    notes.classList.add("empty");
  }
}

function renderTextList(char, listName, selector) {
  const container = $(selector);
  container.innerHTML = "";
  const listNode = char.querySelector(listName);
  if (!listNode) return;

  groupChildren(listNode).forEach((item) => {
    const name = textOf(item, "name");
    const textNode = item.querySelector("text");
    let detail = "";
    if (textNode) {
      detail = textNode.textContent.replace(/\s+/g, " ").trim();
    }
    const note = abilityNoteForItem(item);
    const row = buildAbilityRow(name, note, detail);
    container.appendChild(row);
  });
}

function renderSimpleList(char, listName, selector) {
  const container = $(selector);
  container.innerHTML = "";
  const listNode = char.querySelector(listName);
  if (!listNode) return;

  groupChildren(listNode).forEach((item) => {
    const name = textOf(item, "name");
    const note = abilityNoteForItem(item);
    const row = buildAbilityRow(name, note, "");
    container.appendChild(row);
  });
}

function abilityNoteForItem(item) {
  return textOf(item, "source") || textOf(item, "type") || textOf(item, "shortdescription") || "";
}

function buildAbilityRow(name, noteText, detailText) {
  const li = document.createElement("li");
  li.className = "ability-row";

  const nameDiv = document.createElement("div");
  nameDiv.className = "ability-name";
  nameDiv.textContent = name || "Unnamed";
  li.appendChild(nameDiv);

  const noteDiv = document.createElement("div");
  noteDiv.className = "ability-note";
  noteDiv.textContent = noteText || "";
  li.appendChild(noteDiv);

  if (detailText) {
    const detailDiv = document.createElement("div");
    detailDiv.className = "ability-detail";
    detailDiv.textContent = detailText;
    li.appendChild(detailDiv);
    li.addEventListener("click", () => {
      li.classList.toggle("expanded");
    });
  } else {
    li.classList.add("ability-row-static");
  }

  return li;
}

function groupPowersByNamePrefix(powersNode) {
  const groups = {};
  groupChildren(powersNode).forEach((p) => {
    const groupName = textOf(p, "group") || "Other";
    if (!groups[groupName]) groups[groupName] = [];
    groups[groupName].push(p);
  });
  return groups;
}

function renderPowers(char) {
  const powersNode = char.querySelector("powers");
  const actionsContainer = $("#actions-body");
  const spellsMain = $("#spells-main");
  actionsContainer.innerHTML = "";
  spellsMain.innerHTML = "";
  if (!powersNode) return;

  const groups = groupPowersByNamePrefix(powersNode);

  Object.keys(groups).forEach((groupName) => {
    const list = groups[groupName];

    if (groupName.startsWith("Spells")) {
      // Spells tab style grouping by level
      const byLevel = {};
      list.forEach((p) => {
        const level = numberOf(p, "level", 0);
        if (!byLevel[level]) byLevel[level] = [];
        byLevel[level].push(p);
      });

      Object.keys(byLevel).sort((a, b) => a - b).forEach((levelKey) => {
        const lvl = Number(levelKey);
        const groupDiv = document.createElement("div");
        groupDiv.className = "panel spell-group";
        const header = document.createElement("div");
        header.className = "panel-header";
        header.textContent = lvl === 0 ? `${groupName} (Cantrips)` : `${groupName} (Level ${lvl})`;
        groupDiv.appendChild(header);

        const body = document.createElement("div");
        body.className = "panel-body";
        const table = document.createElement("table");
        table.className = "table";
        table.innerHTML = `
          <thead>
            <tr>
              <th>Name</th>
              <th>Level</th>
              <th>School</th>
              <th>Range</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");
        byLevel[levelKey].forEach((p) => {
          const tr = document.createElement("tr");
          const name = textOf(p, "name");
          const levelVal = numberOf(p, "level");
          const school = textOf(p, "school");
          const range = textOf(p, "range");
          tr.innerHTML = `
            <td><span class="cell-label">${name}</span></td>
            <td>${levelVal}</td>
            <td>${school}</td>
            <td>${range}</td>
          `;
          tr.addEventListener("click", () => {
            const bits = [];
            bits.push(`Level ${levelVal}`);
            if (school) bits.push(school);
            const castingTime = textOf(p, "castingtime");
            const duration = textOf(p, "duration");
            const components = textOf(p, "components");
            if (castingTime) bits.push(`Cast: ${castingTime}`);
            if (duration) bits.push(`Duration: ${duration}`);
            if (range) bits.push(`Range: ${range}`);
            if (components) bits.push(`Components: ${components}`);
            const headerLine = bits.join(" | ");
            const desc = getSpellDescription(name, p);
            const html = `
              <div class="detail-title">${name}</div>
              <div class="detail-header">${headerLine}</div>
              <div class="detail-body">${desc}</div>
            `;
            toggleDetailRow(tr, 4, html);
          });
          tbody.appendChild(tr);
        });
        body.appendChild(table);
        groupDiv.appendChild(body);
        spellsMain.appendChild(groupDiv);
      });
    } else {
      // Actions / class features / feats displayed in table format
      // Group by groupName only
      const byNote = {};
      list.forEach((p) => {
        const noteKey = groupName || "Other";
        if (!byNote[noteKey]) byNote[noteKey] = [];
        byNote[noteKey].push(p);
      });

      Object.keys(byNote).forEach((noteKey) => {
        const groupDiv = document.createElement("div");
        groupDiv.className = "panel power-group";
        const header = document.createElement("div");
        header.className = "panel-header";
        header.textContent = noteKey;
        groupDiv.appendChild(header);

        const body = document.createElement("div");
        body.className = "panel-body";
        const table = document.createElement("table");
        table.className = "table";
        table.innerHTML = `
          <thead>
            <tr>
              <th>Name</th>
              <th>Level</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");
        byNote[noteKey].forEach((p) => {
          const tr = document.createElement("tr");
          const name = textOf(p, "name");
          const level = numberOf(p, "level");
          const descNode = p.querySelector("description");
          const desc = descNode ? descNode.textContent.replace(/\s+/g, " ").trim() : "";

          const noteBits = [];
          const type = textOf(p, "type");
          if (type) noteBits.push(type);
          const recharge = textOf(p, "recharge");
          if (recharge) noteBits.push(recharge);
          const notes = noteBits.join(" | ") || "";

          tr.innerHTML = `
            <td><span class="cell-label">${name}</span></td>
            <td>${level || ""}</td>
            <td>${notes}</td>
          `;
          if (desc) {
            tr.addEventListener("click", () => {
              const html = `
                <div class="detail-title">${name}</div>
                <div class="detail-body">${desc}</div>
              `;
              toggleDetailRow(tr, 3, html);
            });
          }
          tbody.appendChild(tr);
        });
        body.appendChild(table);
        groupDiv.appendChild(body);
        actionsContainer.appendChild(groupDiv);
      });
    }
  });
}

function setupTabs() {
  const buttons = $all(".tab-button");
  const tabs = $all(".tab-content");
  const sheet = $(".fg-sheet");

  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const tabName = btn.getAttribute("data-tab");
      buttons.forEach((b) => b.classList.toggle("active", b === btn));
      tabs.forEach((tab) => {
        tab.classList.toggle("active", tab.id === `tab-${tabName}`);
      });
      if (sheet) {
        sheet.scrollTop = 0;
      }
    });
  });
}

window.addEventListener("DOMContentLoaded", () => {
  setupTabs();
  const input = document.getElementById("xmlInput");
  if (input) {
    input.addEventListener("change", handleFileSelect);
  }
});
</script>
</body>
</html>

